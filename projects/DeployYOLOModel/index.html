<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>基于YOLO模型的目标检测与识别实现在ESP32-S3 EYE上全流程部署 - Zhihao Li - Zhihao Li&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="Zhihao Li - Zhihao Li&#039;s Blog"><meta name="msapplication-TileImage" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/logo_light.png"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Zhihao Li - Zhihao Li&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="文章主要基于 YOLOV5 模型在自定义的数据集上训练，实现特定类别的目标检测与识别，并将训练好的模型部署在ESP32-S3上。"><meta property="og:type" content="blog"><meta property="og:title" content="基于YOLO模型的目标检测与识别实现在ESP32-S3 EYE上全流程部署"><meta property="og:url" content="https://lzhms.github.io/projects/DeployYOLOModel/"><meta property="og:site_name" content="Zhihao Li - Zhihao Li&#039;s Blog"><meta property="og:description" content="文章主要基于 YOLOV5 模型在自定义的数据集上训练，实现特定类别的目标检测与识别，并将训练好的模型部署在ESP32-S3上。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/learning/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-11-01%20114502.png"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/learning/20241101120252.png"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130092009.png"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130092111.png"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/81d9564bf8bcd8c6ea227685cf07fed.png"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/2_jpg.rf.7f9d780304b70d3f77e09cba65e44814.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/0_10725_jpg.rf.7d109ee3b08ec1cd96b169a7d6cb7169.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/6_jpg.rf.d5fadd15bb330accbd0d738a448bf292.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/522108_png.rf.fa8afd9bc916d648acfbfd28233e6af6.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/432075_jpg.rf.443280bd24d81e695d9d6a8e2f920dfc.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/all_4_jpg.rf.b3dbb755fd749dfc2af4c2709fe0103c.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/sfsfsfsf_jpeg_jpg.rf.7578bacc0d95504ce476bedb02531c3f.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/images70_png_jpg.rf.ad9c051c79518695adcf9d775ce62f76.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130104258.png"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130104937.png"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/9b76e1302cf8a5412abd2a38231405a.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/596a366ffa86b05fa47c66861008195.jpg"><meta property="og:image" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/d111f1e5982837ab65fc885044d16c0.jpg"><meta property="article:published_time" content="2024-11-01T03:10:39.000Z"><meta property="article:modified_time" content="2024-11-30T03:11:42.661Z"><meta property="article:author" content="Zhihao Li"><meta property="article:tag" content="Model Deployment"><meta property="article:tag" content="Object Detection"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/learning/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-11-01%20114502.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://lzhms.github.io/projects/DeployYOLOModel/"},"headline":"基于YOLO模型的目标检测与识别实现在ESP32-S3 EYE上全流程部署","image":["https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/learning/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-11-01%20114502.png","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/learning/20241101120252.png","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130092009.png","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130092111.png","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/81d9564bf8bcd8c6ea227685cf07fed.png","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/2_jpg.rf.7f9d780304b70d3f77e09cba65e44814.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/0_10725_jpg.rf.7d109ee3b08ec1cd96b169a7d6cb7169.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/6_jpg.rf.d5fadd15bb330accbd0d738a448bf292.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/522108_png.rf.fa8afd9bc916d648acfbfd28233e6af6.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/432075_jpg.rf.443280bd24d81e695d9d6a8e2f920dfc.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/all_4_jpg.rf.b3dbb755fd749dfc2af4c2709fe0103c.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/sfsfsfsf_jpeg_jpg.rf.7578bacc0d95504ce476bedb02531c3f.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/images70_png_jpg.rf.ad9c051c79518695adcf9d775ce62f76.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130104258.png","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130104937.png","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/9b76e1302cf8a5412abd2a38231405a.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/596a366ffa86b05fa47c66861008195.jpg","https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/d111f1e5982837ab65fc885044d16c0.jpg"],"datePublished":"2024-11-01T03:10:39.000Z","dateModified":"2024-11-30T03:11:42.661Z","author":{"@type":"Person","name":"Zhihao Li"},"publisher":{"@type":"Organization","name":"Zhihao Li - Zhihao Li's Blog","logo":{"@type":"ImageObject","url":"https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/logo_light.png"}},"description":"文章主要基于 YOLOV5 模型在自定义的数据集上训练，实现特定类别的目标检测与识别，并将训练好的模型部署在ESP32-S3上。"}</script><link rel="canonical" href="https://lzhms.github.io/projects/DeployYOLOModel/"><link rel="icon" href="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/logo_light.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="/css/icons/iconfont.css"><link data-pjax rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.7.0/style.css"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img class="logo-img" src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/logo_light.png" alt="Zhihao Li - Zhihao Li&#039;s Blog" height="28"><img class="logo-img-dark" src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/logo_dark.png" alt="Zhihao Li - Zhihao Li&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">ZHIHAO LI&#039;S LOG BOOK</a><a class="navbar-item" href="/blog">BLOG</a><a class="navbar-item" href="/knowledge">KNOWLEDGE</a><a class="navbar-item" href="/publications">PUBLICATIONS</a><a class="navbar-item" href="/projects">PROJECTS</a><a class="navbar-item" href="/essay">ESSAY</a><a class="navbar-item" href="/readings">READINGS</a><a class="navbar-item" href="/collaboration">COLLABORATION</a><a class="navbar-item" href="/archives">ARCHIVES</a><a class="navbar-item" href="/categories">CATEGORIES</a><a class="navbar-item" href="/tags">TAGS</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/LZHMS"><i class="iconfont icon-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/LZHMS"><i class="iconfont icon-gitee1"></i></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">基于YOLO模型的目标检测与识别实现在ESP32-S3 EYE上全流程部署</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2024-11-01T03:10:39.000Z" title="2024-11-01T03:10:39.000Z">2024-11-01</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2024-11-30T03:11:42.661Z" title="2024-11-30T03:11:42.661Z">2024-11-30</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/projects/">projects</a></span><span class="level-item"><i class="far fa-clock"></i> 28 minutes read (About 4142 words)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><div class="content"><h2 id="项目环境安装"><a href="#项目环境安装" class="headerlink" title="项目环境安装"></a>项目环境安装</h2><h3 id="ESP-IDF安装"><a href="#ESP-IDF安装" class="headerlink" title="ESP-IDF安装"></a>ESP-IDF安装</h3><p>ESP-IDF 5.0+ 的版本有较大改动，在部署过程中会出现一些问题，建议使用 4.4 版本的进行安装。<br>基于 Windows 平台的软件安装，可以参考 <a target="_blank" rel="noopener" href="https://dl.espressif.com/dl/esp-idf/">https://dl.espressif.com/dl/esp-idf/</a>. 按照流程完成安装即可。</p>
<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>本项目整体开发环境主要基于训练框架，以及对应esp32的模型部署框架，具体如下：</p>
<ol>
<li>训练、转换模型: <a target="_blank" rel="noopener" href="https://github.com/Seeed-Studio/ModelAssistant">Model Assistant</a></li>
<li>模型部署: <a target="_blank" rel="noopener" href="https://github.com/Seeed-Studio/sscma-example-esp32/tree/1.0.0">sscma-example-esp32(1.0.0)</a></li>
</ol>
<h3 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">python3<span class="number">.10</span> + CUDA11<span class="number">.7</span> + esp-idf <span class="number">4.4</span></span><br><span class="line"><span class="comment"># 主要按照 ModelAssistant/requirements_cuda.txt 进行安装</span></span><br><span class="line">torch                        <span class="number">2.0</span><span class="number">.0</span>+cu117</span><br><span class="line">torchaudio                   <span class="number">2.0</span><span class="number">.1</span>+cu117</span><br><span class="line">torchvision                  <span class="number">0.15</span><span class="number">.1</span>+cu117</span><br><span class="line">yapf                         <span class="number">0.40</span><span class="number">.2</span></span><br><span class="line">typing_extensions            <span class="number">4.5</span><span class="number">.0</span></span><br><span class="line">tensorboard                  <span class="number">2.13</span><span class="number">.0</span></span><br><span class="line">tensorboard-data-server      <span class="number">0.7</span><span class="number">.2</span></span><br><span class="line">tensorflow                   <span class="number">2.13</span><span class="number">.0</span></span><br><span class="line">keras                        <span class="number">2.13</span><span class="number">.1</span></span><br><span class="line">tensorflow-estimator         <span class="number">2.13</span><span class="number">.0</span></span><br><span class="line">tensorflow-intel             <span class="number">2.13</span><span class="number">.0</span></span><br><span class="line">tensorflow-io-gcs-filesystem <span class="number">0.31</span><span class="number">.0</span></span><br><span class="line">sscma                        <span class="number">2.0</span><span class="number">.0</span>rc3</span><br><span class="line">setuptools                   <span class="number">60.2</span><span class="number">.0</span></span><br><span class="line">rich                         <span class="number">13.4</span><span class="number">.2</span></span><br><span class="line">Pillow                       <span class="number">9.4</span><span class="number">.0</span></span><br><span class="line">mmcls                        <span class="number">1.0</span><span class="number">.0</span>rc6</span><br><span class="line">mmcv                         <span class="number">2.0</span><span class="number">.0</span></span><br><span class="line">mmdet                        <span class="number">3.0</span><span class="number">.0</span></span><br><span class="line">mmengine                     <span class="number">0.10</span><span class="number">.1</span></span><br><span class="line">mmpose                       <span class="number">1.2</span><span class="number">.0</span></span><br><span class="line">mmyolo                       <span class="number">0.5</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>conda 的环境依赖主要见上面各种库的版本，其中 </p>
<ul>
<li><code>mmcv</code> 库安装<br><code>mmcv</code> 库的安装需要对应 <code>cuda</code> 版本、<code>torch</code> 版本以及 <code>python</code> 版本，具体说明：cu117，torch2.0.0，python3.10可以参考<br><a target="_blank" rel="noopener" href="https://download.openmmlab.com/mmcv/dist/cu117/torch2.0.0/index.html">https://download.openmmlab.com/mmcv/dist/cu117/torch2.0.0/index.html</a>，对应其中主要根据操作系统选择性安装，<code>./mmcv-2.0.1-cp310-cp310-manylinux1_x86_64.whl</code> 和 <code>./mmcv-2.0.1-cp310-cp310-win_amd64.whl</code> 文件，具体如下，<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/learning/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202024-11-01%20114502.png" alt="mmcv库安装" width="70%"/></li>
</ul>
<h2 id="训练数据集准备"><a href="#训练数据集准备" class="headerlink" title="训练数据集准备"></a>训练数据集准备</h2><h3 id="添加自定义数据集"><a href="#添加自定义数据集" class="headerlink" title="添加自定义数据集"></a>添加自定义数据集</h3><p>主要的数据集可以从开源的 <a target="_blank" rel="noopener" href="https://universe.roboflow.com/">Roboflow Universe</a> 搜集，比如我们需要识别某些类别，可以在该网站上下载对应的数据集，下载格式选择 COCO 格式，如下图所示：<br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/learning/20241101120252.png" alt="数据集下载示例" width="70%"/></p>
<p>将下载的数据集压缩包放置在 <code>data/collection</code> 目录下面，对各个类别数据集加压并重命名为类别名称，例如 “face”, “phone”，即类别标签。</p>
<p>挑选多个类别数据集后（这里选取 “face, phone”），需要对其进行合并，利用下述代码进行合并（<strong>主要合并 json 文件，并拷贝各类别数据集的图像文件</strong>）：</p>
<figure class="highlight python"><figcaption><span>prepare.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save paths</span></span><br><span class="line">train_path = <span class="string">&#x27;datasets/collection/train&#x27;</span></span><br><span class="line">valid_path = <span class="string">&#x27;datasets/collection/valid&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create directories if not exist</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(train_path):</span><br><span class="line">    os.makedirs(train_path)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(valid_path):</span><br><span class="line">    os.makedirs(valid_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Add_Class_COCO_Data</span>(<span class="params">dataset_path, classname, dataset, dataset_info</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(dataset_path, <span class="string">&#x27;_annotations.coco.json&#x27;</span>), <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        class_data = json.load(file)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># check if the class already exists in the train data</span></span><br><span class="line">    class_exist, class_id = <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> dataset[<span class="string">&#x27;categories&#x27;</span>]:</span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&#x27;name&#x27;</span>] == classname:</span><br><span class="line">            class_exist, class_id = <span class="literal">True</span>, item[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> class_exist <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        class_id = dataset_info[<span class="string">&#x27;category_id&#x27;</span>]</span><br><span class="line">        dataset[<span class="string">&#x27;categories&#x27;</span>].append(&#123;<span class="string">&#x27;id&#x27;</span>: class_id, <span class="string">&#x27;name&#x27;</span>: classname&#125;)</span><br><span class="line">        dataset_info[<span class="string">&#x27;category_id&#x27;</span>] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># add the class images for the train data</span></span><br><span class="line">    image_id = dataset_info[<span class="string">&#x27;img_id&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> class_data[<span class="string">&#x27;images&#x27;</span>]:</span><br><span class="line">        image_info = &#123;<span class="string">&#x27;id&#x27;</span>: dataset_info[<span class="string">&#x27;img_id&#x27;</span>], <span class="string">&#x27;file_name&#x27;</span>: image[<span class="string">&#x27;file_name&#x27;</span>], <span class="string">&#x27;width&#x27;</span>: image[<span class="string">&#x27;width&#x27;</span>], <span class="string">&#x27;height&#x27;</span>: image[<span class="string">&#x27;height&#x27;</span>]&#125;</span><br><span class="line">        dataset[<span class="string">&#x27;images&#x27;</span>].append(image_info)</span><br><span class="line">        dataset_info[<span class="string">&#x27;img_id&#x27;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># add the class annotations for the train data</span></span><br><span class="line">    <span class="keyword">for</span> ann <span class="keyword">in</span> class_data[<span class="string">&#x27;annotations&#x27;</span>]:</span><br><span class="line">        ann_info = &#123;<span class="string">&#x27;id&#x27;</span>: dataset_info[<span class="string">&#x27;ann_id&#x27;</span>], <span class="string">&#x27;image_id&#x27;</span>: image_id+ann[<span class="string">&#x27;image_id&#x27;</span>], <span class="string">&#x27;category_id&#x27;</span>: class_id, <span class="string">&#x27;bbox&#x27;</span>: ann[<span class="string">&#x27;bbox&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;area&#x27;</span>: ann[<span class="string">&#x27;area&#x27;</span>], <span class="string">&#x27;iscrowd&#x27;</span>: ann[<span class="string">&#x27;iscrowd&#x27;</span>]&#125;</span><br><span class="line">        dataset[<span class="string">&#x27;annotations&#x27;</span>].append(ann_info)</span><br><span class="line">        dataset_info[<span class="string">&#x27;ann_id&#x27;</span>] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Copy_Files</span>(<span class="params">src_dir, dst_dir, skip_files=[<span class="string">&#x27;_annotations.coco.json&#x27;</span>]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Copy the files from source directory to the destination directory.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    os.makedirs(dst_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> file_name <span class="keyword">in</span> os.listdir(src_dir):</span><br><span class="line">        <span class="comment"># skip some files</span></span><br><span class="line">        <span class="keyword">if</span> file_name <span class="keyword">in</span> skip_files:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        src_file = os.path.join(src_dir, file_name)</span><br><span class="line">        dst_file = os.path.join(dst_dir, file_name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(src_file):</span><br><span class="line">            shutil.copy(src_file, dst_file)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Copied: <span class="subst">&#123;src_file&#125;</span> -&gt; <span class="subst">&#123;dst_file&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Skipping directory: <span class="subst">&#123;src_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># training classes</span></span><br><span class="line">classes = [<span class="string">&quot;face&quot;</span>, <span class="string">&quot;phone&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># store the combined data</span></span><br><span class="line">category_id = <span class="number">0</span></span><br><span class="line">train_data = &#123;<span class="string">&#x27;categories&#x27;</span>: [], <span class="string">&#x27;images&#x27;</span>: [], <span class="string">&#x27;annotations&#x27;</span>: []&#125;</span><br><span class="line">train_info = &#123;<span class="string">&#x27;category_id&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;img_id&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;ann_id&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">valid_data = &#123;<span class="string">&#x27;categories&#x27;</span>: [], <span class="string">&#x27;images&#x27;</span>: [], <span class="string">&#x27;annotations&#x27;</span>: []&#125;</span><br><span class="line">valid_info = &#123;<span class="string">&#x27;category_id&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;img_id&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;ann_id&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">class_data_root = <span class="string">&#x27;./data/collection&#x27;</span></span><br><span class="line"><span class="keyword">for</span> cls_name <span class="keyword">in</span> classes:</span><br><span class="line">    class_train_path = os.path.join(class_data_root, cls_name, <span class="string">&#x27;train&#x27;</span>)</span><br><span class="line">    class_valid_path = os.path.join(class_data_root, cls_name, <span class="string">&#x27;valid&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    Add_Class_COCO_Data(class_train_path, cls_name, train_data, train_info)</span><br><span class="line">    Add_Class_COCO_Data(class_valid_path, cls_name, valid_data, valid_info)</span><br><span class="line"></span><br><span class="line">    Copy_Files(class_train_path, train_path)</span><br><span class="line">    Copy_Files(class_valid_path, valid_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save data to file</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(train_path, <span class="string">&#x27;_annotations.coco.json&#x27;</span>), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    json.dump(train_data, f, indent=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(valid_path, <span class="string">&#x27;_annotations.coco.json&#x27;</span>), <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    json.dump(valid_data, f, indent=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; length of categories: <span class="subst">&#123;<span class="built_in">len</span>(train_data[<span class="string">&#x27;categories&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; length of train_data: <span class="subst">&#123;<span class="built_in">len</span>(train_data[<span class="string">&#x27;images&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;&gt;&gt;&gt; length of valid_data: <span class="subst">&#123;<span class="built_in">len</span>(valid_data[<span class="string">&#x27;images&#x27;</span>])&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>合并后的统一的训练和验证数据集全部放在了 <code>datasets/collection</code> 目录下面，以便于后续模型训练使用。</p>
<h2 id="下载预训练模型"><a href="#下载预训练模型" class="headerlink" title="下载预训练模型"></a>下载预训练模型</h2><p>参考 <a target="_blank" rel="noopener" href="https://github.com/Seeed-Studio/sscma-model-zoo/blob/main/notebooks/zh_CN/Face_Detection_Swift-YOLO_96.ipynb">Face Detection - Swift-YOLO</a> 下载预训练模型权重文件 <a target="_blank" rel="noopener" href="https://files.seeedstudio.com/sscma/model_zoo/detection/face_detection/swift_yolo_1xb16_300e_coco_300_sha1_fe1d7dec30d62e583a7ccf717fd6585c792570bf.pth">pretrain.pth</a>，然后保存在 <code>ModelAssistant/checkpoints</code> 文件夹下。</p>
<h2 id="训练-YOLO-模型"><a href="#训练-YOLO-模型" class="headerlink" title="训练 YOLO 模型"></a>训练 YOLO 模型</h2><p>在 ModelAssistant 项目下，采用的是仓库提供的 Swift YOLO 模型，作者解释说明该模型具有优化的端侧运行性能：”We implemented a lightweight object detection algorithm called Swift YOLO, which is designed to run on low-cost hardware with limited computing power. The visualization tool, model training and export command-line interface has refactored now”.</p>
<p>采用 swift_yolo_tiny_1xb16_300e_coco 的配置文件进行训练，训练命令如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># training the yolo model</span></span><br><span class="line">python tools/train.py configs/swift_yolo/swift_yolo_tiny_1xb16_300e_coco.py \</span><br><span class="line">--cfg-options \</span><br><span class="line">    work_dir=work_dirs/collection \</span><br><span class="line">    num_classes=<span class="number">2</span> \</span><br><span class="line">    epochs=<span class="number">300</span> \</span><br><span class="line">    height=<span class="number">96</span> \</span><br><span class="line">    width=<span class="number">96</span> \</span><br><span class="line">    data_root=datasets/collection/ \</span><br><span class="line">    load_from=checkpoints/pretrain.pth</span><br></pre></td></tr></table></figure>

<h2 id="模型量化和格式转换"><a href="#模型量化和格式转换" class="headerlink" title="模型量化和格式转换"></a>模型量化和格式转换</h2><p>训练完毕后，还需要对模型进行权重量化以及格式转换，这样才能够让模型成功在 ESP32S3 主板上运行。在工作目录 <code>work_dirs/collection</code> 下，找到最好的 <code>bbox_mAP</code> 的模型，例如这里是 <code>best_coco_bbox_mAP_epoch_300.pth</code>，采用以下命令导出模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># export the model</span></span><br><span class="line">python tools/export.py configs/swift_yolo/swift_yolo_tiny_1xb16_300e_coco.py ./work_dirs/collection/best_coco_bbox_mAP_epoch_300.pth --cfg-options  \</span><br><span class="line">    work_dir=work_dirs/collection \</span><br><span class="line">    num_classes=<span class="number">2</span> \</span><br><span class="line">    epochs=<span class="number">300</span>  \</span><br><span class="line">    height=<span class="number">96</span> \</span><br><span class="line">    width=<span class="number">96</span> \</span><br><span class="line">    data_root=datasets/collection/ \</span><br><span class="line">    load_from=checkpoints/pretrain.pth</span><br></pre></td></tr></table></figure>
<p>导出的模型会保存在 <code>work_dirs/collection</code> 文件夹下，生成 <code>best_coco_bbox_mAP_epoch_300_int8.tflite</code> 文件，这是量化到 Int8 格式的 tflite 文件，可以用于后续模型的部署。</p>
<h2 id="模型结果评估"><a href="#模型结果评估" class="headerlink" title="模型结果评估"></a>模型结果评估</h2><h3 id="训练损失"><a href="#训练损失" class="headerlink" title="训练损失"></a>训练损失</h3><p>在整个 300 epoches 的训练过程中，对应的类别损失以及目标检测损失的变化如下图所示：<br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130092009.png" alt="类别损失" width="70%"/><br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130092111.png" alt="目标检测损失" width="70%"/></p>
<h3 id="评估指标"><a href="#评估指标" class="headerlink" title="评估指标"></a>评估指标</h3><p>在该项目中，主要测定了 Swift YOLO Tiny 结构以及 Swift YOLO Tiny Nano 结构（一种高度紧凑的深卷积神经网络，用于使用人机协同设计策略设计的嵌入式目标检测），主要的评估指标如下所示：<br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/81d9564bf8bcd8c6ea227685cf07fed.png"  alt="mAP 评估指标" width="70%"/></p>
<p>考虑到部署到端侧设备上时，更关注于目标检测的置信度，因此下面主要从置信度、平均推理时间的角度进行评估。</p>
<table>
<thead>
<tr>
<th align="center">Model</th>
<th align="center">Precision</th>
<th align="center">Class</th>
<th align="center">Confidence</th>
<th align="center">Infer_Time(ms)</th>
<th align="center">Size(MB)</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_float32.tflite">Swift YOLO Tiny</a></td>
<td align="center">Float32</td>
<td align="center">Face</td>
<td align="center">69.57 %</td>
<td align="center">6.44</td>
<td align="center">3.63</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_float32.tflite">Swift YOLO Tiny</a></td>
<td align="center">Float32</td>
<td align="center">Phone</td>
<td align="center">54.86 %</td>
<td align="center">6.44</td>
<td align="center">3.63</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_float32.tflite">Swift YOLO Tiny</a></td>
<td align="center">Float32</td>
<td align="center">[Face, Phone]</td>
<td align="center">62.21 %</td>
<td align="center">6.44</td>
<td align="center">3.63</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_int8.tflite">Swift YOLO Tiny</a></td>
<td align="center">Int8</td>
<td align="center">Face</td>
<td align="center">68.75 %</td>
<td align="center">6.69</td>
<td align="center">1.05</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_int8.tflite">Swift YOLO Tiny</a></td>
<td align="center">Int8</td>
<td align="center">Phone</td>
<td align="center">55.18 %</td>
<td align="center">6.69</td>
<td align="center">1.05</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_int8.tflite">Swift YOLO Tiny</a></td>
<td align="center">Int8</td>
<td align="center">[Face, Phone]</td>
<td align="center">61.97 %</td>
<td align="center">6.69</td>
<td align="center">1.05</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_nano_float32.tflite">Swift YOLO Tiny Nano</a></td>
<td align="center">Float32</td>
<td align="center">Face</td>
<td align="center">73.62 %</td>
<td align="center">8.02</td>
<td align="center">9.13</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_nano_float32.tflite">Swift YOLO Tiny Nano</a></td>
<td align="center">Float32</td>
<td align="center">Phone</td>
<td align="center">55.76 %</td>
<td align="center">8.02</td>
<td align="center">9.13</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_nano_float32.tflite">Swift YOLO Tiny Nano</a></td>
<td align="center">Float32</td>
<td align="center">[Face, Phone]</td>
<td align="center">64.69 %</td>
<td align="center">8.02</td>
<td align="center">9.13</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_nano_int8.tflite">Swift YOLO Tiny Nano</a></td>
<td align="center">Int8</td>
<td align="center">Face</td>
<td align="center">74.62 %</td>
<td align="center">12.86</td>
<td align="center">2.49</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_nano_int8.tflite">Swift YOLO Tiny Nano</a></td>
<td align="center">Int8</td>
<td align="center">Phone</td>
<td align="center">55.62 %</td>
<td align="center">12.86</td>
<td align="center">2.49</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_nano_int8.tflite">Swift YOLO Tiny Nano</a></td>
<td align="center">Int8</td>
<td align="center">[Face, Phone]</td>
<td align="center">65.12 %</td>
<td align="center">12.86</td>
<td align="center">2.49</td>
</tr>
</tbody></table>
<ul>
<li>可以看到，模型量化压缩后在能够维持较高的精度的情况下，模型大小显著减小，但是推理时间并没有降低，甚至约有增加；</li>
<li>Swift YOLO Tiny Nano 的精度更高，但是模型大小更大，推理时间更长，在 ESP32S3-EYE 设备上牺牲的代价就是帧率较低；</li>
<li>整体而言，模型的置信度都已经比较高以及推理速度能比较不错，能够满足实际应用需求。</li>
</ul>
<p>此外，我还尝试了保持原图像尺寸，即对于Swift YOLO Tiny配置而言，设置模型处理的图像宽高都是640，具体如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># training the yolo model</span></span><br><span class="line">python tools/train.py configs/swift_yolo/swift_yolo_tiny_1xb16_300e_coco.py \</span><br><span class="line">--cfg-options \</span><br><span class="line">    work_dir=work_dirs/collection_640 \</span><br><span class="line">    num_classes=<span class="number">2</span> \</span><br><span class="line">    epochs=<span class="number">300</span> \</span><br><span class="line">    height=<span class="number">640</span> \</span><br><span class="line">    width=<span class="number">640</span> \</span><br><span class="line">    data_root=datasets/collection/ \</span><br><span class="line">    load_from=checkpoints/pretrain.pth</span><br></pre></td></tr></table></figure>

<p>训练后模型的评估指标如下所示：</p>
<table>
<thead>
<tr>
<th align="center">Model</th>
<th align="center">Precision</th>
<th align="center">Class</th>
<th align="center">Confidence</th>
<th align="center">Infer_Time(ms)</th>
<th align="center">Size(MB)</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_float32_wh640.tflite">Swift YOLO Tiny WH640</a></td>
<td align="center">Float32</td>
<td align="center">Face</td>
<td align="center">74.83 %</td>
<td align="center">54.08</td>
<td align="center">3.88</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_float32_wh640.tflite">Swift YOLO Tiny WH640</a></td>
<td align="center">Float32</td>
<td align="center">Phone</td>
<td align="center">65.47 %</td>
<td align="center">54.08</td>
<td align="center">3.88</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_float32_wh640.tflite">Swift YOLO Tiny WH640</a></td>
<td align="center">Float32</td>
<td align="center">[Face, Phone]</td>
<td align="center">70.15 %</td>
<td align="center">54.08</td>
<td align="center">3.88</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_int8_wh640.tflite">Swift YOLO Tiny WH640</a></td>
<td align="center">Int8</td>
<td align="center">Face</td>
<td align="center">75.52 %</td>
<td align="center">71.87</td>
<td align="center">1.20</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_int8_wh640.tflite">Swift YOLO Tiny WH640</a></td>
<td align="center">Int8</td>
<td align="center">Phone</td>
<td align="center">65.46 %</td>
<td align="center">71.87</td>
<td align="center">1.20</td>
</tr>
<tr>
<td align="center"><a href="../../files/models/projects/swift_yolo_int8_wh640.tflite">Swift YOLO Tiny WH640</a></td>
<td align="center">Int8</td>
<td align="center">[Face, Phone]</td>
<td align="center">70.49 %</td>
<td align="center">71.87</td>
<td align="center">1.20</td>
</tr>
</tbody></table>
<p>虽然整体的精度有所提升，但是推理时间显著增加，模型虽然大小基本维持不变，但是推理时间增大了将近10倍，处理图像的分辨率所带来的开销远远超过了模型识别的精度。事实上，Swift YOLO Tiny WH640 在 ESP32S3-EYE 设备上已经没办法运行，实际中会出现数据存储栈溢出的问题，摄像头采集的图像分辨率太高导致栈空间不足。</p>
<h3 id="模型推理"><a href="#模型推理" class="headerlink" title="模型推理"></a>模型推理</h3><p>主要是观测量化后模型对验证集的推理结果，具体如下：</p>
<div class="justified-gallery">
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/2_jpg.rf.7f9d780304b70d3f77e09cba65e44814.jpg" />
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/0_10725_jpg.rf.7d109ee3b08ec1cd96b169a7d6cb7169.jpg"/>
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/6_jpg.rf.d5fadd15bb330accbd0d738a448bf292.jpg"/>
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/522108_png.rf.fa8afd9bc916d648acfbfd28233e6af6.jpg"/>
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/432075_jpg.rf.443280bd24d81e695d9d6a8e2f920dfc.jpg"/>
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/all_4_jpg.rf.b3dbb755fd749dfc2af4c2709fe0103c.jpg"/>
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/sfsfsfsf_jpeg_jpg.rf.7578bacc0d95504ce476bedb02531c3f.jpg"/>
<img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/images70_png_jpg.rf.ad9c051c79518695adcf9d775ce62f76.jpg"/>
</div>

<h2 id="模型部署"><a href="#模型部署" class="headerlink" title="模型部署"></a>模型部署</h2><h3 id="部署环境"><a href="#部署环境" class="headerlink" title="部署环境"></a>部署环境</h3><p>部署环境为 ESP32-S3 EYE 开发板，没判断错的话，它有 4MB Flash，我们烧录的模型也主要存储在这个区域，当然它也附带了 SD 卡功能，可以从 SD 卡中加载模型。4 MB 的 Flash 分配主要在 partitions.csv 文件中，具体如下：</p>
<figure class="highlight plaintext"><figcaption><span>partitions.csv</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Name	   Type	 SubType	 Offset	  Size	 Flags</span><br><span class="line"># Note: if you change the phy_init or app partition offset	 make sure to change the offset in Kconfig.projbuild				</span><br><span class="line">factory	 app	  factory	 0x010000	2048K</span><br><span class="line">nvs	     data	 nvs	0x3D0000	 64K</span><br><span class="line">fr	      data	   	      0x3E0000	 128K</span><br></pre></td></tr></table></figure>

<p>默认 app 分区最多有 2048K 即 2MB 的大小，但是由于地址空间还很充裕，例如从 <code>0x010000</code> 到 <code>0x3D0000</code> 的大小，最多可以分配 3MB 的空间，足够上述量化后的模型存储。此外，分区表主要以 64KB 为单位分配的，所以偏移地址后四位都为0. 可以在项目中通过 <code>idf.py build</code> 查看输出信息，其中包含了对分区大小是否合适以及剩余空间的判断。</p>
<article class="message is-info">
        
        <div class="message-body">
            <p>对于 Swift YOLO Tiny Nano 配置，需要将分区表中的 app 分区增大到 3MB 即 3072K.</p>

        </div>
    </article>

<h3 id="导入模型"><a href="#导入模型" class="headerlink" title="导入模型"></a>导入模型</h3><p>对于烧录程序而言，需要将 tflite 格式模型转换为 c 语言格式，具体在项目 <code>sscma-example-esp32-1.0.0</code> 中，通过 <code>tools/tflite2c.py</code> 文件进行转换，但是为了能够在显示屏上同步显示检测的类别名称，需要修改其中的代码，即<strong>将 classes 换成字符串，然后通过分词找到各个类别，并将其转换为字符串列表，其中每个字符串都是一个类别名称</strong>，具体如下：</p>
<figure class="highlight python"><figcaption><span>tools/tflite2c.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_args</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&#x27;Convert tflite to c or cpp file&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--input&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;input tflite file&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--output_dir&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;output directory&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--name&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;model name&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--cpp&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>,</span><br><span class="line">                        default=<span class="literal">True</span>, <span class="built_in">help</span>=<span class="string">&#x27;output cpp file&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--classes&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;classes name&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    args = parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">input</span> = args.<span class="built_in">input</span></span><br><span class="line">    name = args.name</span><br><span class="line">    output_dir = args.output_dir</span><br><span class="line">    classes = args.classes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> classes != <span class="literal">None</span>:</span><br><span class="line">        classes = <span class="built_in">list</span>(classes.split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="built_in">input</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;input file not exist&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> name == <span class="literal">None</span>:</span><br><span class="line">        name = <span class="built_in">input</span>.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>].split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    output_h = os.path.join(output_dir, name + <span class="string">&#x27;_model_data.h&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.cpp:</span><br><span class="line">        output_c = os.path.join(output_dir, name + <span class="string">&#x27;_model_data.cpp&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        output_c = os.path.join(output_dir, name + <span class="string">&#x27;_model_data.c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="built_in">input</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f_input:</span><br><span class="line">        data = f_input.read()</span><br><span class="line">        <span class="keyword">if</span> data[<span class="number">4</span>:<span class="number">8</span>] != <span class="string">b&#x27;TFL3&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;input file is not tflite&#x27;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        data = binascii.hexlify(data)</span><br><span class="line">        data = data.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_h, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f_output_h:</span><br><span class="line">            f_output_h.write(<span class="string">&#x27;#ifndef __%s_MODEL_DATA_H__\r\n&#x27;</span> % name.upper())</span><br><span class="line">            f_output_h.write(<span class="string">&#x27;#define __%s_MODEL_DATA_H__\r\n&#x27;</span> % name.upper())</span><br><span class="line">            f_output_h.write(<span class="string">&#x27;\r\n//this file is generated by tflite2c.py\r\n&#x27;</span>)</span><br><span class="line">            f_output_h.write(<span class="string">&#x27;\r\n#include &lt;stdint.h&gt;\r\n&#x27;</span>)</span><br><span class="line">            f_output_h.write(</span><br><span class="line">                <span class="string">&#x27;extern const unsigned char g_%s_model_data[];\r\n&#x27;</span> % name)</span><br><span class="line">            f_output_h.write(</span><br><span class="line">                <span class="string">&#x27;extern const unsigned int g_%s_model_data_len;\r\n&#x27;</span> % name)</span><br><span class="line">            <span class="keyword">if</span> classes != <span class="literal">None</span>:</span><br><span class="line">                f_output_h.write(</span><br><span class="line">                    <span class="string">&#x27;extern const char* g_%s_model_classes[];\r\n&#x27;</span> % name)</span><br><span class="line">                f_output_h.write(</span><br><span class="line">                    <span class="string">&#x27;extern const unsigned int g_%s_model_classes_num;\r\n&#x27;</span> % name)</span><br><span class="line"></span><br><span class="line">            f_output_h.write(<span class="string">&#x27;\r\n#endif\r\n&#x27;</span>)</span><br><span class="line">            f_output_h.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_c, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f_output_c:</span><br><span class="line">            f_output_c.write(<span class="string">&#x27;#include &lt;stdint.h&gt;\r\n&#x27;</span>)</span><br><span class="line">            f_output_c.write(<span class="string">&#x27;\r\n#include &quot;%s_model_data.h&quot;\r\n\r\n&#x27;</span> % name)</span><br><span class="line">            f_output_c.write(</span><br><span class="line">                <span class="string">&#x27;const unsigned char g_%s_model_data[] = &#123;\r\n&#x27;</span> % name)</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">2</span>):</span><br><span class="line">                f_output_c.write(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">                f_output_c.write(data[i])</span><br><span class="line">                f_output_c.write(data[i+<span class="number">1</span>])</span><br><span class="line">                f_output_c.write(<span class="string">&#x27;, &#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> i % <span class="number">36</span> == <span class="number">34</span>:</span><br><span class="line">                    f_output_c.write(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">            f_output_c.write(<span class="string">&#x27;&#125;;\r\n\r\n&#x27;</span>)</span><br><span class="line">            f_output_c.write(</span><br><span class="line">                <span class="string">&#x27;const unsigned int g_%s_model_data_len = %d;\r\n&#x27;</span> % (name, <span class="built_in">len</span>(data) // <span class="number">2</span>))</span><br><span class="line">            <span class="keyword">if</span> classes != <span class="literal">None</span>:</span><br><span class="line">                f_output_c.write(</span><br><span class="line">                    <span class="string">&#x27;const char* g_%s_model_classes[] = &#123;&#x27;</span> % name)</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classes)):</span><br><span class="line">                    f_output_c.write(<span class="string">&#x27;&quot;%s&quot;, &#x27;</span> % classes[i])</span><br><span class="line">                f_output_c.write(<span class="string">&#x27;&#125;;\r\n\r\n&#x27;</span>)</span><br><span class="line">                f_output_c.write(</span><br><span class="line">                    <span class="string">&#x27;const unsigned int g_%s_model_classes_num = %d;\r\n&#x27;</span> % (name, <span class="built_in">len</span>(classes)))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                f_output_c.write(</span><br><span class="line">                    <span class="string">&#x27;const char* g_%s_model_classes[] = &#123;&#125;;\r\n&#x27;</span> % name)</span><br><span class="line">                f_output_c.write(</span><br><span class="line">                    <span class="string">&#x27;const unsigned int g_%s_model_classes_num = 0;\r\n&#x27;</span> % name)</span><br><span class="line"></span><br><span class="line">            f_output_c.close()</span><br><span class="line">        f_input.close()</span><br></pre></td></tr></table></figure>
<p>同时为了能够在显示屏上显示置信度，还需要在 <code>components/modules/algorithm/algo_yolo.cpp</code> 文件中修改相应的代码，具体如下所示：</p>
<figure class="highlight c++"><figcaption><span>components/modules/algorithm/algo_yolo.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (std::<span class="built_in">distance</span>(_yolo_list.<span class="built_in">begin</span>(), _yolo_list.<span class="built_in">end</span>()) &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    found = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    Objects found: %d\n&quot;</span>, std::<span class="built_in">distance</span>(_yolo_list.<span class="built_in">begin</span>(), _yolo_list.<span class="built_in">end</span>()));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    Objects:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    [\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;yolo : _yolo_list)</span><br><span class="line">    &#123;</span><br><span class="line">        yolo.x = <span class="built_in">uint16_t</span>(<span class="built_in">float</span>(yolo.x) / <span class="built_in">float</span>(w) * <span class="built_in">float</span>(frame-&gt;width));</span><br><span class="line">        yolo.y = <span class="built_in">uint16_t</span>(<span class="built_in">float</span>(yolo.y) / <span class="built_in">float</span>(h) * <span class="built_in">float</span>(frame-&gt;height));</span><br><span class="line">        yolo.w = <span class="built_in">uint16_t</span>(<span class="built_in">float</span>(yolo.w) / <span class="built_in">float</span>(w) * <span class="built_in">float</span>(frame-&gt;width));</span><br><span class="line">        yolo.h = <span class="built_in">uint16_t</span>(<span class="built_in">float</span>(yolo.h) / <span class="built_in">float</span>(h) * <span class="built_in">float</span>(frame-&gt;height));</span><br><span class="line">        <span class="built_in">fb_gfx_drawRect2</span>(frame, yolo.x - yolo.w / <span class="number">2</span>, yolo.y - yolo.h / <span class="number">2</span>, yolo.w, yolo.h, box_color[index % (<span class="built_in">sizeof</span>(box_color) / <span class="built_in">sizeof</span>(box_color[<span class="number">0</span>]))], <span class="number">4</span>);</span><br><span class="line">        <span class="comment">// fb_gfx_printf(frame, yolo.x - yolo.w / 2, yolo.y - yolo.h/2 - 5, 0x1FE0, 0x0000, &quot;%s&quot;, g_yolo_model_classes[yolo.target]);</span></span><br><span class="line">        <span class="built_in">fb_gfx_printf</span>(frame, yolo.x - yolo.w / <span class="number">2</span>, yolo.y - yolo.h/<span class="number">2</span> - <span class="number">5</span>, <span class="number">0x1FE0</span>, <span class="string">&quot;%s:%d&quot;</span>, g_yolo_model_classes[yolo.target], yolo.confidence);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;        &#123;\&quot;class\&quot;: \&quot;%d\&quot;, \&quot;x\&quot;: %d, \&quot;y\&quot;: %d, \&quot;w\&quot;: %d, \&quot;h\&quot;: %d, \&quot;confidence\&quot;: %d&#125;,\n&quot;</span>, yolo.target, yolo.x, yolo.y, yolo.w, yolo.h, yolo.confidence);</span><br><span class="line">        index++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    ]\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后具体的转换命令如下所示，这将会在文件夹 <code>components/modules/model</code> 中生成两个文件 <code>yolo_model_data.h</code> 和 <code>yolo_model_data.cpp</code>，其中 <code>yolo_model_data.h</code> 中包含了模型数据的声明，<code>yolo_model_data.cpp</code> 中包含了模型数据的定义。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python tools/tflite2c.py --<span class="built_in">input</span> ./model_zoo/facephone_96/best_coco_bbox_mAP_epoch_300_int8.tflite --name yolo --output_dir ./components/modules/model --classes <span class="string">&quot;person,phone&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="烧录模型"><a href="#烧录模型" class="headerlink" title="烧录模型"></a>烧录模型</h3><p>模型准备完毕后，就可以利用乐鑫的 IDF 开发工具链将模型烧录进开发板中，具体过程主要是：</p>
<ol>
<li>使用 <code>ESP-IDF 4.4 CMD</code> 进入 <code>sscma-example-esp32-1.0.0</code> 项目的 <code>examples/yolo</code> 目录下；</li>
<li>使用 <code>idf.py set-target esp32s3</code> 设置目标芯片为 <code>esp32s3</code>；</li>
<li>使用 <code>idf.py build</code> 命令编译项目；</li>
<li>使用 <code>idf.py flash monitor</code> 命令烧录项目。</li>
</ol>
<h3 id="结果展示"><a href="#结果展示" class="headerlink" title="结果展示"></a>结果展示</h3><h4 id="Swift-YOLO-Tiny-Nano"><a href="#Swift-YOLO-Tiny-Nano" class="headerlink" title="Swift YOLO Tiny Nano"></a>Swift YOLO Tiny Nano</h4><p>在 ESP32S3 设备上平均每张图像的处理时间是 628 ms，在端侧设备上出现帧率较低，稍微偏卡顿的效果。但是准确度提高的也不是很多，因此首选还是 Swift YOLO Tiny。<br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130104258.png" alt="模型端口监控结果" width="70%"/></p>
<h4 id="Swift-YOLO-Tiny"><a href="#Swift-YOLO-Tiny" class="headerlink" title="Swift YOLO Tiny"></a>Swift YOLO Tiny</h4><p>在 ESP32S3 设备上平均每张图像的处理时间是 268 ms，实时监测的帧率非常不错，已经很流畅，准确性而言也是较为不错的，具体结果如下所示：<br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/20241130104937.png" alt="模型端口监控结果" width="70%"/></p>
<p>实际的开发板检测结果如下所示：<br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/9b76e1302cf8a5412abd2a38231405a.jpg"  alt="单个人脸检测" width="20%"/><br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/596a366ffa86b05fa47c66861008195.jpg"  alt="多个人脸检测" width="20%"/><br><img src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/projects/d111f1e5982837ab65fc885044d16c0.jpg"  alt="手机检测" width="20%"/></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要介绍了如何利用 Model Assistant、sscma-example-esp32-1.0.0 项目将 YOLO 模型部署到 ESP32S3 EYE 设备上，并且通过自定义数据集实现训练、导出、转换、导入、部署模型整个流程，也对实际开发板进行了测试，最终得到了较为理想的结果。</p>
<p>本文主要选取了 “face, phone” 两个类别进行训练，如果需要训练更多的类别，可以添加更多的类别，但是会存在目标检测上限以及端侧设备计算性能的限制，需要进一步平衡。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 15px;">
    <p>esp32-s3训练自己的数据进行目标检测、图像分类.</p>
    <p>
        <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45977690/article/details/135137552">
            https://blog.csdn.net/weixin_45977690/article/details/135137552
        </a>
    </p>
</div>

<div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 15px;">
    <p>SenseCraft Model Assistant by Seeed Studio.</p>
    <p>
        <a target="_blank" rel="noopener" href="https://github.com/Seeed-Studio/ModelAssistant">
            https://github.com/Seeed-Studio/ModelAssistant
        </a>
    </p>
</div>

<div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 15px;">
    <p>EdgeLab Deployment on Espressif Chipsets.</p>
    <p>
        <a target="_blank" rel="noopener" href="https://github.com/Seeed-Studio/sscma-example-esp32/tree/1.0.0">
            https://github.com/Seeed-Studio/sscma-example-esp32/tree/1.0.0
        </a>
    </p>
</div>


<div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 15px;">
    <p>Explore the Roboflow Universe.</p>
    <p>
        <a target="_blank" rel="noopener" href="https://universe.roboflow.com/">
            https://universe.roboflow.com/
        </a>
    </p>
</div></div><div class="article-licensing box"><div class="licensing-title"><p>基于YOLO模型的目标检测与识别实现在ESP32-S3 EYE上全流程部署</p><p><a href="https://lzhms.github.io/projects/DeployYOLOModel/">https://lzhms.github.io/projects/DeployYOLOModel/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Zhihao Li</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-11-01</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-11-30</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/Model-Deployment/">Model Deployment,</a><a class="link-muted" rel="tag" href="/tags/Object-Detection/">Object Detection </a></div></div><div class="sharethis-inline-reaction-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=6713c7a4f9d5250012f5d817&amp;product=inline-reaction-buttons&amp;source=platform" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/projects/TransformerPractice/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Transformer Concept Exploration and Practice in Pytorch</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/blog/CoursesAnalysis/"><span class="level-item">Courses Analysis Tutorial Using MicroSoft Power BI</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comments"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="content twikoo" id="twikoo"></div><script src="https://cdnjs.loli.net/ajax/libs/twikoo/1.6.30/twikoo.all.min.js"></script><script>twikoo.init({
            envId: 'https://twikoo-netlify-comment.netlify.app/.netlify/functions/twikoo',
            region: "ap-guangzhou",
            lang: "en",
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-96x96 mx-auto mb-2"><img class="avatar is-rounded" src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/avatar.png" alt="Zhihao Li"></figure><p class="title is-size-4 is-block" style="line-height: 'inherit';">Zhihao Li</p><p style="white-space: pre-line; font-style: italic; margin-bottom: 0.50rem; font-size: 1.0em">Computer Science
Machine Learning
</p><p class="is-size-5 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Xidian University, Xi&#039;an, China</span></p></div></div></nav><nav class="level menu-list is-mobile" style="margin-bottom:1rem"><a class="level-item has-text-centered is-marginless" href="/archives/"><div><p class="heading">Posts</p><div><p class="title">54</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/categories/"><div><p class="heading">Categories</p><div><p class="title">6</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/tags/"><div><p class="heading">Tags</p><div><p class="title">40</p></div></div></a></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/LZHMS" target="_blank" rel="noopener"><i class="fab fa-github"></i>  Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Bilibili" href="https://space.bilibili.com/2079836440"><i class="iconfont icon-bilibili"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="QQ" href="https://jsd.cdn.zzko.cn/gh/LZHMS/picx-images-hosting@master/Profile/1730463517285_temp_qrcode_share_9993.64dv175zqu.webp"><i class="iconfont icon-QQ1"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="WeChat" href="https://jsd.cdn.zzko.cn/gh/LZHMS/picx-images-hosting@master/Profile/0add852711e38990022788ba88dd062.3nrmm9y3ql.webp"><i class="iconfont icon-wechat-"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:zhihaoli@stu.xidian.edu.cn"><i class="iconfont icon-email2"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Transcript" href="/./pdf/profile/transcript.pdf"><i class="iconfont icon-chengjidan1"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#项目环境安装"><span class="level-left"><span class="level-item">1</span><span class="level-item">项目环境安装</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ESP-IDF安装"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">ESP-IDF安装</span></span></a></li><li><a class="level is-mobile" href="#开发环境"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">开发环境</span></span></a></li><li><a class="level is-mobile" href="#运行环境"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">运行环境</span></span></a></li></ul></li><li><a class="level is-mobile" href="#训练数据集准备"><span class="level-left"><span class="level-item">2</span><span class="level-item">训练数据集准备</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#添加自定义数据集"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">添加自定义数据集</span></span></a></li></ul></li><li><a class="level is-mobile" href="#下载预训练模型"><span class="level-left"><span class="level-item">3</span><span class="level-item">下载预训练模型</span></span></a></li><li><a class="level is-mobile" href="#训练-YOLO-模型"><span class="level-left"><span class="level-item">4</span><span class="level-item">训练 YOLO 模型</span></span></a></li><li><a class="level is-mobile" href="#模型量化和格式转换"><span class="level-left"><span class="level-item">5</span><span class="level-item">模型量化和格式转换</span></span></a></li><li><a class="level is-mobile" href="#模型结果评估"><span class="level-left"><span class="level-item">6</span><span class="level-item">模型结果评估</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#训练损失"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">训练损失</span></span></a></li><li><a class="level is-mobile" href="#评估指标"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">评估指标</span></span></a></li><li><a class="level is-mobile" href="#模型推理"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">模型推理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#模型部署"><span class="level-left"><span class="level-item">7</span><span class="level-item">模型部署</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#部署环境"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">部署环境</span></span></a></li><li><a class="level is-mobile" href="#导入模型"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">导入模型</span></span></a></li><li><a class="level is-mobile" href="#烧录模型"><span class="level-left"><span class="level-item">7.3</span><span class="level-item">烧录模型</span></span></a></li><li><a class="level is-mobile" href="#结果展示"><span class="level-left"><span class="level-item">7.4</span><span class="level-item">结果展示</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Swift-YOLO-Tiny-Nano"><span class="level-left"><span class="level-item">7.4.1</span><span class="level-item">Swift YOLO Tiny Nano</span></span></a></li><li><a class="level is-mobile" href="#Swift-YOLO-Tiny"><span class="level-left"><span class="level-item">7.4.2</span><span class="level-item">Swift YOLO Tiny</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">8</span><span class="level-item">总结</span></span></a></li><li><a class="level is-mobile" href="#References"><span class="level-left"><span class="level-item">9</span><span class="level-item">References</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/"><span class="level-start"><span class="level-item">blog</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/collaboration/"><span class="level-start"><span class="level-item">collaboration</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/essay/"><span class="level-start"><span class="level-item">essay</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/knowledge/"><span class="level-start"><span class="level-item">knowledge</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/projects/"><span class="level-start"><span class="level-item">projects</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/readings/"><span class="level-start"><span class="level-item">readings</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Embedded-System/"><span class="tag">Embedded System</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Project-Tools/"><span class="tag">Project Tools</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Diffusion-Model/"><span class="tag">Diffusion Model</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AIGC/"><span class="tag">AIGC</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Project-Habits/"><span class="tag">Project Habits</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mathematical-Modeling/"><span class="tag">Mathematical Modeling</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Data-Visualization/"><span class="tag">Data Visualization</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenSSL/"><span class="tag">OpenSSL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows/"><span class="tag">Windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Research-Habits/"><span class="tag">Research Habits</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Machine-Learning/"><span class="tag">Machine Learning</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Computer-Network/"><span class="tag">Computer Network</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Collaboration-Project/"><span class="tag">Collaboration Project</span><span class="tag">6</span></a></div></div><div class="more-link"><a href="/tags/">View All Tags &gt;&gt;</a></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img class="logo-img" src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/logo_light.png" alt="Zhihao Li - Zhihao Li&#039;s Blog" height="28"><img class="logo-img-dark" src="https://lzhms.oss-cn-hangzhou.aliyuncs.com/images/blog/profile/logo_dark.png" alt="Zhihao Li - Zhihao Li&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2023-2024 Zhihao Li</span><br><span id="busuanzi_container_site_uv"><span id="busuanzi_container_site_uv">Site UV: <span id="busuanzi_value_site_uv"></span></span>   <span id="busuanzi_container_site_pv">Site PV: <span id="busuanzi_value_site_pv"></span></span></span></p><p class="is-size-7"> </p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="HuggingFace" href="https://huggingface.co/LZHMS"><i class="iconfont icon-huggingface"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="ZhiHu" href="https://www.zhihu.com/people/zhao.li"><i class="iconfont icon-zhihu"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="CSDN" href="https://blog.csdn.net/weixin_63554791"><i class="iconfont icon-csdn"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.15.1/contrib/mhchem.min.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><script type="text/javascript" id="MathJax-script" async>MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      },
      chtml: {
        matchFontHeight: false
      }
    };</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script><!--!--><script data-pjax src="/js/main.js" defer></script><script data-pjax src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script><div id="dark" onclick="switchDarkMode()"></div><script type="text/javascript" src="/js/universe.js"></script></body></html>